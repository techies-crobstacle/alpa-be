generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String
  phone         String?
  role          Role     @default(CUSTOMER)
  isVerified    Boolean  @default(false)
  profileImage  String?
  emailVerified Boolean  @default(false)
  emailVerificationDeadline DateTime? // 7 days from signup after OTP verification
  emailVerificationReminderSentAt DateTime? // Track when 7-day reminder email was sent
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  products      Product[]
  orders        Order[]
  cart          Cart?
  ratings       Rating[]
  supportTickets SupportTicket[]
  sellerProfile SellerProfile?
  notifications Notification[]
  wishlist      Wishlist[]
  orderNotifications OrderNotification[]
  userSessions  UserSession[]
  loginVerifications LoginVerification[]

  @@map("users")
}

model PendingRegistration {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String?
  phone     String?
  mobile    String?
  role      Role
  otp       String
  otpExpiry DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pending_registrations")
}

model UserSession {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceFingerprint     String    // Browser + OS characteristics for device similarity
  trustedDeviceToken    String?   @map("trusted_device_token") // Secure token for trusted device identification
  lastVerifiedAt        DateTime  @default(now())
  verificationExpiryAt  DateTime  // 30 days from last verification for trusted devices
  isActive              Boolean   @default(true)
  revokedAt             DateTime? @map("revoked_at") // When device trust was explicitly revoked
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([userId, deviceFingerprint])
  @@index([trustedDeviceToken])
  @@map("user_sessions")
}

model LoginVerification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String
  otp       String
  otpExpiry DateTime
  deviceFingerprint String
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("login_verifications")
}

model SellerProfile {
  id                      String        @id @default(cuid())
  userId                  String        @unique
  user                    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactPerson           String?
  businessName            String?
  abn                     String?
  businessAddress         String?
  businessType            String?
  yearsInBusiness         Int?
  website                 String?
  culturalBackground      String?
  culturalStory           String?
  storeName               String?
  storeDescription        String?
  storeLogo               String?
  storeBanner             String?
  storeLocation           String?
  kycDocuments            Json?
  kycSubmitted            Boolean       @default(false)
  bankDetails             Json?
  status                  SellerStatus  @default(PENDING)
  culturalApprovalStatus  String        @default("pending")
  culturalApprovalAt      DateTime?
  culturalApprovalFeedback String?
  culturalApprovalBy      String?
  onboardingStep          Int           @default(1)
  submittedForReviewAt    DateTime?
  approvedAt              DateTime?
  rejectedAt              DateTime?
  rejectionReason         String?
  suspendedAt             DateTime?
  suspensionReason        String?
  activatedAt             DateTime?
  activatedBy             String?
  adminNotes              String?
  productCount            Int           @default(0)
  minimumProductsUploaded Boolean       @default(false)
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  @@map("seller_profiles")
}

model Product {
  id          String        @id @default(cuid())
  title       String
  description String?
  price       Decimal       @db.Decimal(10, 2)
  category    String
  stock       Int           @default(0)
  images      String[]
  sellerId    String
  seller      User          @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellerName  String?
  artistName  String?       // Optional artist name field
  status      ProductStatus @default(PENDING)
  isActive    Boolean       @default(false)  // Product approval status
  featured    Boolean       @default(false)
  tags        String[]      @default([])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  cartItems   CartItem[]
  orderItems  OrderItem[]
  ratings     Rating[]
  wishlist    Wishlist[]

  @@index([sellerId])
  @@index([category])
  @@index([status])
  @@index([isActive])
  @@index([featured])
  @@map("products")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id                String      @id @default(cuid())
  userId            String?     // Made optional for guest orders
  user              User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items             OrderItem[]
  totalAmount       Decimal     @db.Decimal(10, 2)
  status            OrderStatus @default(PENDING)
  paymentMethod     String?
  shippingAddress   Json
  trackingNumber    String?
  estimatedDelivery DateTime?
  customerName      String
  customerEmail     String
  customerPhone     String
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  orderNotifications OrderNotification[]

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@map("order_items")
}

model Rating {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  rating    Int      @db.SmallInt
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([productId])
  @@map("ratings")
}

model SupportTicket {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject     String
  message     String
  status      TicketStatus  @default(OPEN)
  priority    Priority      @default(MEDIUM)
  category    String?
  attachments String[]
  response    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  message     String
  type        NotificationType
  isRead      Boolean          @default(false)
  relatedId   String?          // Order ID, Product ID, etc.
  relatedType String?          // "order", "product", "seller", etc.
  metadata    Json?            // Additional data (seller name, order details, etc.)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@map("notifications")
}

model CategoryRequest {
  id                String              @id @default(cuid())
  categoryName      String              @unique
  description       String?
  sampleProduct     String?             // Product reference example
  status            CategoryStatus      @default(PENDING)
  requestedBy       String?             // User ID who requested it (optional)
  approvedBy        String?             // Admin ID who approved it
  rejectedBy        String?             // Admin ID who rejected it
  approvalMessage   String?             // Message when approved
  rejectionMessage  String?             // Message when rejected
  requestedAt       DateTime            @default(now())
  approvedAt        DateTime?
  rejectedAt        DateTime?
  updatedAt         DateTime            @updatedAt

  @@index([status])
  @@index([requestedAt])
  @@map("category_requests")
}

enum NotificationType {
  ORDER_STATUS_CHANGED
  NEW_ORDER
  PRODUCT_STATUS_CHANGED
  LOW_STOCK_ALERT
  SELLER_APPROVED
  SELLER_REJECTED
  NEW_PRODUCT_SUBMITTED
  PAYMENT_RECEIVED
  ORDER_CANCELLED
  PRODUCT_OUT_OF_STOCK
  GENERAL
  ORDER_PROCESSING
  ORDER_CONFIRMATION
  SHIPPING_PREPARATION
  ORDER_SHIPPED
  ORDER_DELIVERED
  PAYMENT_PENDING
  STOCK_ALERT
}

enum Role {
  CUSTOMER
  SELLER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SellerStatus {
  PENDING
  APPROVED
  ACTIVE
  REJECTED
  SUSPENDED
}


enum ProductStatus {
  PENDING
  ACTIVE
  INACTIVE
}

enum CategoryStatus {
  PENDING
  APPROVED
  REJECTED
}

model Coupon {
  id         String   @id @default(cuid())
  code       String   @unique
  discount   Float
  expiresAt  DateTime
  createdBy  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("coupons")
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([userId])
  @@map("wishlists")
}

model OrderNotification {
  id              String               @id @default(cuid())
  orderId         String
  sellerId        String
  type            NotificationType
  priority        Priority             @default(MEDIUM)
  status          NotificationStatus   @default(PENDING)
  message         String?
  notes           String?
  slaDeadline     DateTime
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  completedAt     DateTime?
  acknowledgedAt  DateTime?

  order  Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  seller User  @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([slaDeadline])
  @@map("order_notifications")
}

model ShippingMethod {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Express Shipping", "Standard Shipping"
  description String?  // Additional details about the shipping method
  cost        Decimal  @db.Decimal(10, 2) // Cost in AUD
  estimatedDays String? // e.g., "2-3 business days"
  isActive    Boolean  @default(true) // Can be toggled on/off by admin
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("shipping_methods")
}

model GST {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Standard GST", "Reduced GST"
  percentage  Decimal  @db.Decimal(5, 2) // GST percentage (e.g., 10.00 for 10%)
  description String?  // Additional details about the GST
  isActive    Boolean  @default(true) // Can be toggled on/off by admin
  isDefault   Boolean  @default(false) // Mark as default GST to apply
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("gst_settings")
}

enum NotificationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
